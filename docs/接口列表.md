# 接口列表 #

## 1. 公众号服务器认证接口 ##

接口：`/wx/service`

接入微信公众平台开发，开发者需要按照如下步骤完成：

1. 填写服务器配置
2. 验证服务器地址的有效性
3. 依据接口文档实现业务逻辑

### 第一步：填写服务器配置 ###

登录微信公众平台官网后，在公众平台后台管理页面 - 开发者中心页，点击【修改配置】按钮，填写服务器地址（URL）、Token和EncodingAESKey。


- URL：就是本接口地址，比如`http://xxx.com/wx/service`
- Token：可由开发者可以任意填写，用作生成签名（该Token会和接口URL中包含的Token进行比对，从而验证安全性）
- EncodingAESKey：由开发者手动填写或随机生成，将用作消息体加解密密钥

同时，开发者可选择消息加解密方式：明文模式、兼容模式和安全模式。模式的选择与服务器配置在提交后都会立即生效，请开发者谨慎填写及选择。加解密方式的默认状态为明文模式，选择兼容模式和安全模式需要提前配置好相关加解密代码，详情请参考消息体签名及加解密部分的文档。 

![](https://github.com/diamont1001/wechat-jssdk-server/blob/master/docs/%E5%BE%AE%E4%BF%A1-%E5%BC%80%E5%8F%91%E8%80%85%E4%B8%AD%E5%BF%83.png?raw=true)

### 第二步：验证服务器地址的有效性 ###

开发者提交信息后，微信服务器将发送GET请求到填写的服务器地址URL上，GET请求携带四个参数：
| 参数   | 描述    |
|-------|---------|
| signature | 微信加密签名，signature结合了开发者填写的token参数和请求中的timestamp参数、nonce参数 |
| timestamp | 时间戳 |
| nonce | 随机数 |
| echostr | 随机字符串 |

开发者通过检验signature对请求进行校验（下面有校验方式）。若确认此次GET请求来自微信服务器，请原样返回echostr参数内容，则接入生效，成为开发者成功，否则接入失败。

本接口已完成该流程，尽管配上去就行了。

加密/校验流程如下：

1. 将token、timestamp、nonce三个参数进行字典序排序
2. 将三个参数字符串拼接成一个字符串进行sha1加密
3. 开发者获得加密后的字符串可与signature对比，标识该请求来源于微信

参考：[微信-公众平台开发者文档](http://mp.weixin.qq.com/wiki/17/2d4265491f12608cd170a95559800f2d.html)


## 2. JS-SDK注入权限配置信息接口 ##

接口：`/wx/config?url=`

支持Ajax, jsonp

参数URL：调用JS-SDK的当前网页URL（记得encodeURIComponent）

接口返回（遵循[接口协议]()）：
- appId: 公众号ID
- timestamp: 生成签名的Unix时间戳（以秒为单位）
- nonceStr: 随机字符串
- signature: 签名

参考例子：`/public/test/wx/config.html`

返回例子：

	{
	    "state" : {
	        "code" : 2000000,
	        "msg" : "ok"
	    },
	    "data" : {
	        "appId" : "wxc91a34030c7bb9c6",
	        "timestamp" : "1453364807",
	        "nonceStr" : "u78NQJ6FgS4eWW6",
	        "signature" : "10687b5efe41818dbac67203d1473395390f635e"
	    }
	}

### 接口支持JSONP协议方式 ###

比如请求：http://xxx.com/wx/config?url=http%3A%2F%2Fbaidu.com&callback=onSuccess

返回数据：

	abc({
	    "state" : {
	        "code" : 2000000,
	        "msg" : "ok"
	    },
	    "data" : {
	        "appId" : "wxc91a34030c7bb9c6",
	        "timestamp" : "1453364807",
	        "nonceStr" : "u78NQJ6FgS4eWW6",
	        "signature" : "10687b5efe41818dbac67203d1473395390f635e"
	    }
	})

### 微信JS-SDK使用说明 ###
微信JS-SDK是微信公众平台面向网页开发者提供的基于微信内的网页开发工具包。

通过使用微信JS-SDK，网页开发者可借助微信高效地使用拍照、选图、语音、位置等手机系统的能力，同时可以直接使用微信分享、扫一扫、卡券、支付等微信特有的能力，为微信用户提供更优质的网页体验。

此文档面向网页开发者介绍微信JS-SDK如何使用及相关注意事项。

参考: [JS-SDK开发者文档](http://mp.weixin.qq.com/wiki/7/aaa137b55fb2e0456bf8dd9148dd613f.html#.E6.AD.A5.E9.AA.A4.E4.BA.8C.EF.BC.9A.E5.BC.95.E5.85.A5JS.E6.96.87.E4.BB.B6)

### JSSDK使用步骤 ###

#### 步骤一：绑定域名 ####
先登录微信公众平台进入“[公众号设置](https://mp.weixin.qq.com/cgi-bin/loginpage?t=wxm2-login&lang=zh_CN)”的“功能设置”里填写“JS接口安全域名”。

备注：登录后可在“开发者中心”查看对应的接口权限。

#### 步骤二：引入JS文件 ####
在需要调用JS接口的页面引入如下JS文件，（支持https）：[http://res.wx.qq.com/open/js/jweixin-1.0.0.js](http://res.wx.qq.com/open/js/jweixin-1.0.0.js)

请注意，如果你的页面启用了https，务必引入 [https://res.wx.qq.com/open/js/jweixin-1.0.0.js](https://res.wx.qq.com/open/js/jweixin-1.0.0.js) ，否则将无法在iOS9.0以上系统中成功使用JSSDK

如需使用摇一摇周边功能，请引入 jweixin-1.1.0.js

备注：支持使用 AMD/CMD 标准模块加载方法加载

#### 通过config接口注入权限验证配置（本接口） ####

首先通过本服务器接口获取注入相关参数：

	$.ajax({
        url: 'http://xxx.com/wx/config?url=' + window.location.href,
        type: 'get',
        dataType: 'jsonp',
        jsonp: 'callback',
        jsonpCallback: 'test',
        success: function(rst){
            wxConfig(rst.data);
        },
        error: function(){
            alert('error');
        }
    });

获取到参数后，即可调用wx.config接口进行接口使用申请。

所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用（同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用,目前Android微信客户端不支持pushState的H5新特性，所以使用pushState来实现web app的页面会导致签名失败，此问题在Android6.2中修复）。

	wx.config({
	    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
	    appId: '', // 必填，公众号的唯一标识
	    timestamp: , // 必填，生成签名的时间戳
	    nonceStr: '', // 必填，生成签名的随机串
	    signature: '',// 必填，签名，见附录1
	    jsApiList: [] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
	});

#### 步骤四：通过ready接口处理成功验证 ####

	wx.ready(function(){

	    // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
	});

#### 步骤五：通过error接口处理失败验证 ####

	wx.error(function(res){

	    // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
	
	});


## 3. 网页授权获取用户基本信息（OAuth2.0） ##

接口：`/wx/auth`

协议：页面访问，不支持Ajax（有302跳转）

参数dest: 当前页的回调地址，微信授权过后，服务端会带上用户信息并302跳转到dest（记得encodeURIComponent）

接口返回：302跳转回dest链接，后面带有userinfo={OBJECT}

参考例子：`/public/test/wx/auth.html`

userinfo字段返回说明
| 参数 | 描述 |
|-----|------|
| openid | 用户的唯一标识 |
| nickname | 用户昵称 |
| sex | 用户的性别，值为1时是男性，值为2时是女性，值为0时是未知 |
| province | 用户个人资料填写的省份 |
| city | 普通用户个人资料填写的城市 |
| country | 国家，如中国为CN |
| headimgurl | 用户头像，最后一个数值代表正方形头像大小（有0、46、64、96、132数值可选，0代表640*640正方形头像），用户没有头像时该项为空。若用户更换头像，原有头像URL将失效 |
| privilege | 用户特权信息，json 数组，如微信沃卡用户为（chinaunicom） |
| unionid | 只有在用户将公众号绑定到微信开放平台帐号后，才会出现该字段。详见：[获取用户个人信息（UnionID机制）](https://open.weixin.qq.com/cgi-bin/frame?t=resource/res_main_tmpl&lang=zh_CN&target=res/app_wx_login) |

### 用户再次进入页面不用重复授权 ###
服务器在用户首次授权后，会以openId为key把access_token, refresh_token等信息都保存到redis里，同时给用户把openId写在cookies上。

所以用户在授过权后，第二次进入页面就不用再手动点击授权了，跳过获取code和获取access_token的步骤，直接从redis里获取access_token，再去请求userinfo。

数据缓存时间：7天

### access_token自更新 ###
因为access_token有效期为2小时，而因为refresh_token有效期最少为7天，所以这些数据服务器保留了7天时间。

每分钟会有定时器检查access-token的过期时间，发现过期时间少于8分钟则自动去更新。

通过refresh_token去微信服务器更新access_token，并重新写到redis。

所以，理论上，用户在7天内都只需要手动授权一次即可。

